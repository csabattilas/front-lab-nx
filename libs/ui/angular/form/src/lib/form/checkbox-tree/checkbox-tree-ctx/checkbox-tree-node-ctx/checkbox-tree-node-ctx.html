<ul>
  <li>
    <div class="checkbox-tree-node" [style.--depth]="depth()">
      @if (checkboxComponent()) {
      <ng-container
        *ngTemplateOutlet="
        genericCheckbox;
        context: {
          onToggle,
          checked,
          indeterminate,
          checkboxComponent
        }
      "
      ></ng-container>
      } @else {
      <div class="default-checkbox">
        <input
          type="checkbox"
          [checked]="checked()"
          [indeterminate]="indeterminate()"
          (change)="onToggle($event)"
        />
        <ng-container
          *ngTemplateOutlet="titleTemplate; context: { node: this.node(), toggleExpanded: toggleExpanded.bind(this), hasChildren }"
        ></ng-container>
        @if (hasChildren) {
        <span class="material-symbols-outlined">
          {{ expandedSignal() ? 'expand_less' : 'expand_more' }}
        </span>
        }
      </div>
      } @if (hasChildren) {
      <span class="material-symbols-outlined">
        {{ expandedSignal() ? 'expand_less' : 'expand_more' }}
      </span>
      }
    </div>
    @if (hasChildren) { @for (node of node().items; track node.id) {
    <fl-form-checkbox-tree-node-ctx
      [style.display]="expandedSignal() ? 'block' : 'none'"
      [node]="node"
      [inheritedChecked]="checked()"
      [expanded]="expanded()"
      [checkboxComponent]="checkboxComponent()"
      [depth]="depth()+1"
    ></fl-form-checkbox-tree-node-ctx>
    } }
  </li>
</ul>

<ng-template
  #titleTemplate
  let-node="node"
  let-toggleExpanded="toggleExpanded"
  let-expandedSignal="expandedSignal"
  let-hasChildren="hasChildren"
>
  @if(hasChildren) {
  <button (click)="toggleExpanded()">{{ node.title }}</button>
  } @else {
  <span>{{ node.title }}</span>
  }
</ng-template>

<ng-template
  #genericCheckbox
  let-checkboxComponent="checkboxComponent"
  let-onToggle="onToggle"
  let-checked="checked"
  let-indeterminate="indeterminate"
>
  <ng-container
    #checkboxComponentRef
    *ngComponentOutlet="
      checkboxComponent();
      inputs: {
        checked: checked(),
        indeterminate: indeterminate()
      }
      content: [titleNode()];
      componentRef as checkboxComponentRef
    "
  >
  </ng-container>
</ng-template>
